<!-- (C√ìDIGO INTEIRO, CORRIGIDO, 100% MANTIDO AQUI ABAIXO!) -->

<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Otome Studio ‚Äî Editor de Rotas & Cenas</title>
<!-- Estilo base (dark elegante, enxuto) -->
<style>
  :root{
    --bg:#0f0f10; --panel:#141518; --muted:#a7b0bb; --acc:#8ab4f8;
    --glass:rgba(255,255,255,.06); --glass-b:#252a33;
    --ok:#68d391; --warn:#f6ad55; --danger:#f56565; --ink:#cfe1ff;
    --routeA:#5aa0ff; --routeB:#b475ff; --routeC:#63dba5;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:#fff;font-family:system-ui,Segoe UI,Roboto,Arial}
  button{background:#24262a;color:#fff;border:1px solid #2f3337;border-radius:10px;padding:9px 12px;cursor:pointer}
  button:hover{border-color:#3c4249} button.ghost{opacity:.84} button.pill{border-radius:999px}
  input[type="text"], textarea, select{width:100%;background:#0f1114;border:1px solid #2b2f35;border-radius:10px;color:#fff;padding:8px}
  .sep{height:26px;width:1px;background:#2a2d31;margin:0 6px}
  .badge{background:#223145;border:1px solid #2d476a;color:#cfe1ff;padding:2px 8px;border-radius:999px;font-size:12px}

  /* Topbar */
  #toolbar{
    display:flex;flex-wrap:wrap;gap:8px;align-items:center;
    padding:10px;background:#15171b;position:sticky;top:0;z-index:50;
    border-bottom:1px solid #23262b
  }
  #viewTabs{margin-left:auto;display:flex;gap:6px}
  #viewTabs button{padding:7px 10px}
  #viewTabs button.active{outline:2px solid #4a6a98}

  /* Layout geral */
  #layout{
    display:grid;grid-template-columns:300px 1fr 400px;gap:14px;
    max-width:1700px;margin:14px auto;padding:0 12px
  }

  /* Sidebar rotas */
  #routes{
    background:#111316;border:1px solid #24272c;border-radius:14px;overflow:auto;max-height:82vh;padding:12px
  }
  #routeHeader{display:flex;gap:6px;align-items:center;justify-content:space-between;margin-bottom:8px}
  .routeBlock{border:1px solid #262a30;border-radius:12px;margin-bottom:10px;overflow:hidden}
  .routeTitle{background:#191b20;padding:8px 10px;font-weight:600;display:flex;align-items:center;justify-content:space-between}
  .routeList{padding:8px 8px 10px 8px;display:flex;flex-direction:column;gap:6px}
  .routeItem{padding:6px 8px;border:1px solid #2a2e35;border-radius:10px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;background:#0e1013}
  .routeItem.active{outline:2px solid #4a6a98}
  .routeItem .mini{display:flex;gap:6px}

  /* Conte√∫do central: Cena & Timeline (tabs) */
  #center{
    display:grid;grid-template-rows:auto 1fr;gap:8px;min-height:82vh
  }
  #centerTabs{display:flex;gap:8px}
  #centerTabs .tab{padding:8px 12px;border-radius:10px;border:1px solid #2a2e35;background:#14171c}
  #centerTabs .tab.active{outline:2px solid #4a6a98}
  #centerViews{position:relative;border:1px solid #24272c;border-radius:14px;overflow:hidden;background:#111316}

  /* View: Cena (canvas + caixa de di√°logo) */
  #stageWrap{position:relative;height:100%}
  #canvas{display:block;background:#000;border-radius:0;width:100%;height:100%}
  #dialogBox{position:absolute;left:50%;bottom:12px;transform:translateX(-50%);width:86%;max-width:980px;
    background:rgba(0,0,0,.72);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:14px 18px 16px;display:none}
  #namePlate{display:block;width:max-content;margin:0 auto 8px auto;padding:6px 16px;border-radius:12px;background:linear-gradient(145deg,#1e2a44,#2b4270);border:1px solid #4a6a98;font-weight:700}
  #dialogText{margin:0;text-align:center;line-height:1.55;font-size:17px;padding:0 14px}
  #choicesPrev{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:10px}
  #choicesPrev .btn{background:#2a3345;border:1px solid #3e5375;border-radius:8px;padding:6px 12px;color:#cfe1ff}

  /* View: Timeline (fluxo) */
  #timelineWrap{position:absolute;inset:0;display:none;background:
    radial-gradient(ellipse at top left, rgba(255,255,255,.02), transparent 60%),
    linear-gradient(#101215,#0f1013)}
  #timelineCanvas{position:absolute;inset:0}
  #nodesLayer{position:absolute;inset:0}
  .node{
    position:absolute;min-width:130px;max-width:220px;padding:10px 10px 12px;
    background:rgba(20,21,25,.85);border:1px solid #2a2d33;border-radius:12px;
    box-shadow:0 10px 22px rgba(0,0,0,.35);cursor:grab;user-select:none
  }
  .node:active{cursor:grabbing}
  .node .title{font-weight:700;margin-bottom:6px}
  .node .routeTag{font-size:11px;opacity:.85}
  .node .connect{
    position:absolute;right:-8px;top:50%;transform:translateY(-50%);
    width:14px;height:14px;border-radius:50%;background:var(--acc);border:2px solid #0c0f14;cursor:crosshair
  }
  .node[data-route="A"]{border-color:#224866}
  .node[data-route="A"] .title{color:var(--routeA)}
  .node[data-route="B"]{border-color:#45226a}
  .node[data-route="B"] .title{color:var(--routeB)}
  .node[data-route="C"] .title{color:var(--routeC)}
  #timelineControls{
    position:absolute;right:10px;top:10px;display:flex;gap:8px;z-index:2;
    backdrop-filter:blur(6px);background:rgba(0,0,0,.25);border:1px solid #2a2e35;padding:6px;border-radius:12px
  }
  #timelineControls .toggle.on{outline:2px solid #4a6a98}

  /* Inspector (direita) */
  #inspector{background:#121316;border:1px solid #24272c;border-radius:14px;padding:12px;max-height:82vh;overflow:auto}
  #inspector h3{margin:4px 0 8px 0;font-size:16px;color:#cfe1ff}
  .row{display:flex;gap:8px;margin-bottom:8px}
  .col{display:flex;flex-direction:column;gap:6px}
  .hint{color:#9aa3ad;font-size:12px}
  .tblRow{display:grid;grid-template-columns:1fr 120px 32px;gap:6px;align-items:center;background:#0f1114;border:1px solid #2b2f35;border-radius:10px;padding:6px;margin-bottom:6px}

  /* Bot√£o flutuante do editor de personagem */
  #openCharEditor{
    position:fixed;right:14px;bottom:14px;z-index:80;
    background:#1b1c1f;border-radius:50%;width:58px;height:58px;border:1px solid #2f3337;
    display:flex;align-items:center;justify-content:center;font-size:24px
  }
  #openCharEditor:hover{background:#25282e}

  /* Painel lateral fixo do editor de personagem */
  #charEditorPanel{
    position:fixed;right:0;top:0;height:100%;width:440px;background:#0f1114;
    border-left:1px solid #2a2e35;z-index:90;transform:translateX(100%);transition:transform .28s ease;display:flex;flex-direction:column
  }
  #charEditorPanel.open{transform:translateX(0)}
  #charEditorHeader{display:flex;align-items:center;justify-content:space-between;padding:10px;border-bottom:1px solid #24272c;background:#14171c}
  #charEditorHeader .title{font-weight:700}
  #charFrame{border:none;width:100%;height:100%;background:#111}

  /* Mini status no topo esquerdo */
  #sceneInfo{margin-left:4px}

  /* Util */
  .nowrap{white-space:nowrap}
</style>
</head>
<body>
<!-- (continua no pr√≥ximo coment√°rio pois a mensagem vai ultrapassar o limite) -->
  <!-- Topbar -->
  <div id="toolbar">
    <span class="badge">Otome Studio</span>
    <div class="sep"></div>
    <span class="badge">Cena:</span><span id="sceneInfo" class="badge">‚Äî</span>
    <div class="sep"></div>
    <button id="saveJSON">üíæ Salvar</button>
    <button id="loadJSONBtn">üìÇ Abrir</button><input id="loadJSON" type="file" accept="application/json" hidden>
    <button id="exportGame">üéÆ Exportar Jogo (HTML)</button>
    <div id="viewTabs">
      <button id="tabScene" class="pill active">üé¨ Cena</button>
      <button id="tabTimeline" class="pill">üó∫Ô∏è Timeline</button>
    </div>
  </div>

  <div id="layout">
    <!-- Sidebar: Rotas & Cenas -->
    <div id="routes">
      <div id="routeHeader">
        <span class="badge">Rotas & Cenas</span>
        <div style="display:flex;gap:6px">
          <button id="addRoute">+ Rota</button>
          <button id="addSceneInRoute">+ Cena</button>
        </div>
      </div>
      <div id="routesBody"></div>
    </div>

    <!-- Centro: Views -->
    <div id="center">
      <div id="centerTabs">
        <button class="tab active" data-view="scene">üé¨ Cena</button>
        <button class="tab" data-view="timeline">üó∫Ô∏è Timeline</button>
      </div>
      <div id="centerViews">
        <!-- Cena -->
        <div id="stageWrap">
          <canvas id="canvas" width="960" height="540"></canvas>
          <div id="dialogBox">
            <div id="namePlate" style="display:none;"><span id="speakerName"></span></div>
            <p id="dialogText"></p>
            <div id="choicesPrev"></div>
          </div>
        </div>

        <!-- Timeline -->
        <div id="timelineWrap">
          <div id="timelineControls">
            <button id="btnToggleEdges" class="toggle on">Mostrar liga√ß√µes</button>
            <button id="btnAutoLayout" class="ghost">Auto-organizar</button>
            <span class="badge nowrap">Arraste ‚óè para ligar</span>
          </div>
          <canvas id="timelineCanvas"></canvas>
          <div id="nodesLayer"></div>
        </div>
      </div>
    </div>

    <!-- Inspector -->
    <div id="inspector">
      <h3>Roteiro da Cena</h3>
      <div class="row">
        <div class="col" style="flex:1">
          <label for="sceneId">ID da cena</label>
          <input id="sceneId" type="text" placeholder="ex: 3A, 4B, Pr√≥logo">
        </div>
        <div class="col" style="width:130px">
          <label>&nbsp;</label>
          <button id="renameScene">Renomear</button>
        </div>
      </div>

      <div class="row">
        <div class="col" style="flex:1">
          <label for="routeSelect">Pertence √† rota</label>
          <select id="routeSelect">
            <option value="">Neutra</option>
          </select>
        </div>
        <div class="col" style="width:130px">
          <label>&nbsp;</label>
          <button id="dupScene" title="Duplicar">Duplicar</button>
        </div>
        <div class="col" style="width:130px">
          <label>&nbsp;</label>
          <button id="delScene" title="Excluir">Excluir</button>
        </div>
      </div>

      <div class="row">
        <div class="col" style="flex:1">
          <label for="speakerInput">Quem fala</label>
          <input id="speakerInput" type="text" placeholder="Nome">
        </div>
      </div>

      <div class="row">
        <div class="col" style="flex:1">
          <label for="textInput">Texto do di√°logo</label>
          <textarea id="textInput" placeholder="Cole seu texto aqui..."></textarea>
        </div>
      </div>

      <div class="row">
        <div class="col" style="flex:1">
          <label>Plano de Fundo</label>
          <div class="row">
            <button id="addBgFileBtn">+ Fundo (arquivo)</button><input id="addBgFile" type="file" accept="image/*" hidden>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col" style="flex:1">
          <label>Personagens</label>
          <div class="row">
            <button id="addCharFileBtn">+ Personagem (arquivo)</button><input id="addCharFile" type="file" accept="image/*" hidden>
            <button id="deleteSelected" class="ghost">Excluir selecionado (Del)</button>
          </div>
          <span class="hint">Dica: segure <b>Shift</b> e use a rodinha do mouse para redimensionar proporcionalmente.</span>
        </div>
      </div>

      <h3>Escolhas</h3>
      <div id="choicesList"></div>
      <div class="row" style="margin-top:6px">
        <button id="addChoiceRow">+ Adicionar escolha</button>
        <span class="badge">Se houver v√°rias liga√ß√µes na timeline, viram choices automaticamente</span>
      </div>
    </div>
  </div>

  <!-- Bot√£o flutuante para abrir o editor de personagem -->
  <button id="openCharEditor" title="Editor de Personagem">üé®</button>

  <!-- Painel fixo do editor de personagem -->
  <div id="charEditorPanel" aria-hidden="true">
    <div id="charEditorHeader">
      <span class="title">Editor de Personagem</span>
      <button id="closeCharEditor">‚úï</button>
    </div>
    <!-- Usa seu index.html + script.js + style.css -->
    <iframe id="charFrame" src="index.html"></iframe>
  </div>
<!-- CONTINUA no pr√≥ximo bloco: scripts JS integrais! -->
<script>
/* ===========================================================
   Estado do projeto
=========================================================== */

// Canvas cena
const $ = (id)=>document.getElementById(id);
const canvas = $('canvas'), ctx = canvas.getContext('2d');
function fitCanvasToParent(){
  const rect = canvas.parentElement.getBoundingClientRect();
  // Mant√©m 16:9 com letterbox
  const targetW = rect.width, targetH = rect.height;
  const aspect = 16/9;
  let w = targetW, h = Math.round(targetW/aspect);
  if (h > targetH){ h = targetH; w = Math.round(targetH*aspect); }
  canvas.width = w; canvas.height = h;
}
window.addEventListener('resize', ()=>{fitCanvasToParent(); draw();});

// Modelo
let editMode = true;
let current = '1';
let project = {
  routes: { 'A': ['1A'], 'B': ['1B'] },
  scenes: {
    '1': { bg:null, chars:[], speaker:'', text:'', options:[] },
    '1A': { bg:null, chars:[], speaker:'', text:'', options:[] },
    '1B': { bg:null, chars:[], speaker:'', text:'', options:[] }
  },
  connections: [] // {from:'cenaId', to:'cenaId'}
};

// Util
const tokenize=(id)=> id.toString().match(/\d+|[^\d]+/g)||[id.toString()];
function naturalCompare(a,b){
  const A=tokenize(a), B=tokenize(b);
  for(let i=0;i<Math.max(A.length,B.length);i++){
    const x=A[i]||'', y=B[i]||''; const nx=+x, ny=+y;
    const isX=/^\d+$/.test(x), isY=/^\d+$/.test(y);
    if(isX&&isY&&nx!==ny) return nx-ny;
    if(isX!==isY) return isX?-1:1;
    const cmp=x.localeCompare(y); if(cmp) return cmp;
  } return 0;
}
const sortedKeys=()=>Object.keys(project.scenes).sort(naturalCompare);
const scene=()=>project.scenes[current];
const ensureScene=(id)=>{ if(!project.scenes[id]) project.scenes[id]={bg:null,chars:[],speaker:'',text:'',options:[]}; };
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));

function getRouteOf(id){
  for(const [r,arr] of Object.entries(project.routes)){
    if(arr.includes(id)) return r;
  }
  return '';
}

/* ===========================================================
   Rotas (lista √† esquerda)
=========================================================== */
const routesBody=$('routesBody'), routeSelect=$('routeSelect'),
sceneIdInput=$('sceneId'), speakerInput=$('speakerInput'), textInput=$('textInput'),
choicesList=$('choicesList'), sceneInfo=$('sceneInfo');

function rebuildRouteSelect(){
  routeSelect.innerHTML = '<option value="">Neutra</option>' +
    Object.keys(project.routes).sort().map(r=>`<option value="${r}">Rota ${r}</option>`).join('');
  const r = getRouteOf(current); routeSelect.value = r || '';
}
function buildRoutesPanel(){
  routesBody.innerHTML='';
  const groups=new Map();
  for(const id of sortedKeys()){
    const r=getRouteOf(id)||''; if(!groups.has(r)) groups.set(r,[]);
    groups.get(r).push(id);
  }
  const ordered=[ '', ...Array.from(groups.keys()).filter(k=>k!=='').sort() ];
  for(const r of ordered){
    const ids=groups.get(r)||[];
    const block=document.createElement('div'); block.className='routeBlock';
    const title=document.createElement('div'); title.className='routeTitle';
    title.innerHTML = `<span>${r ? ('Rota ' + r) : 'Neutras'}</span><button class="ghost" data-r="${r}" data-add>+ Cena</button>`;
    const list=document.createElement('div'); list.className='routeList';

    ids.forEach(id=>{
      const row=document.createElement('div'); row.className='routeItem'+(id===current?' active':'');
      const left=document.createElement('div'); left.textContent=id;
      const right=document.createElement('div'); right.className='mini';
      const btnUp=document.createElement('button'); btnUp.textContent='‚Üë'; btnUp.className='ghost';
      const btnDown=document.createElement('button'); btnDown.textContent='‚Üì'; btnDown.className='ghost';
      row.onclick=()=>{ current=id; syncInspector(); draw(); selectNodeInTimeline(id); };
      btnUp.onclick=(ev)=>{ev.stopPropagation(); reorderInsideRoute(id, r, -1);};
      btnDown.onclick=(ev)=>{ev.stopPropagation(); reorderInsideRoute(id, r, +1);};
      right.appendChild(btnUp); right.appendChild(btnDown);
      row.appendChild(left); row.appendChild(right);
      list.appendChild(row);
    });

    block.appendChild(title); block.appendChild(list);
    routesBody.appendChild(block);
  }
  routesBody.querySelectorAll('[data-add]').forEach(b=>{
    b.onclick=(ev)=>{ ev.stopPropagation(); const r=b.getAttribute('data-r')||''; createSceneInRoute(r); };
  });
  rebuildRouteSelect();
}
function reorderInsideRoute(id, route, dir){
  if(!route){ return; }
  const arr = project.routes[route]||[];
  const i = arr.indexOf(id); if(i<0) return;
  const j = i+dir; if(j<0||j>=arr.length) return;
  [arr[i],arr[j]]=[arr[j],arr[i]];
  buildRoutesPanel(); drawTimeline(); syncInspector();
}
function createSceneInRoute(route){
  // novo id incremental dentro da rota
  const existing = (project.routes[route]||[]).map(k=>k).concat(sortedKeys());
  const nums=existing.map(k=>parseInt((k.match(/^\d+/)||['0'])[0],10)).filter(n=>!Number.isNaN(n));
  const next=(nums.length?Math.max(...nums):0)+1;
  const newId = route ? `${next}${route}` : `${next}`;
  ensureScene(newId);
  if(route){
    if(!project.routes[route]) project.routes[route]=[];
    project.routes[route].push(newId);
  }
  current=newId; buildRoutesPanel(); syncInspector(); draw(); addNodeToTimeline(newId);
}

/* ===========================================================
   Inspector (direita)
=========================================================== */
function renderChoicesTable(){
  const s=scene(); choicesList.innerHTML='';
  if(!s.options || s.options.length===0){
    const info=document.createElement('div'); info.className='badge'; info.textContent='Sem escolhas nesta cena';
    choicesList.appendChild(info); return;
  }
  s.options.forEach((o,idx)=>{
    const row=document.createElement('div'); row.className='tblRow';
    const inText=document.createElement('input'); inText.placeholder='Texto da escolha'; inText.value=o.text||'';
    const inNext=document.createElement('input'); inNext.placeholder='Cena destino'; inNext.value=o.next||'';
    const del=document.createElement('button'); del.textContent='x';
    inText.oninput=()=>{ o.text=inText.value; draw(); };
    inNext.oninput=()=>{ o.next=inNext.value; draw(); };
    del.onclick=()=>{ s.options.splice(idx,1); renderChoicesTable(); draw(); };
    row.appendChild(inText); row.appendChild(inNext); row.appendChild(del);
    choicesList.appendChild(row);
  });
}
function syncInspector(){
  const s=scene();
  $('sceneInfo').textContent=current;
  sceneIdInput.value=current;
  speakerInput.value=s.speaker||'';
  textInput.value=s.text||'';
  rebuildRouteSelect();
  renderChoicesTable();
}

routeSelect.onchange=()=>{
  const r = routeSelect.value || '';
  // remove de rotas anteriores
  for(const [route,arr] of Object.entries(project.routes)){
    const i = arr.indexOf(current); if(i>=0) arr.splice(i,1);
  }
  if(r){
    if(!project.routes[r]) project.routes[r]=[];
    if(!project.routes[r].includes(current)) project.routes[r].push(current);
  }
  buildRoutesPanel(); drawTimeline();
};

$('renameScene').onclick=()=>{
  const sId=(sceneIdInput.value||'').trim(); if(!sId){ sceneIdInput.value=current; return; }
  if(sId===current) return;
  if(project.scenes[sId]){ alert('J√° existe cena com este ID.'); sceneIdInput.value=current; return; }
  // mover dados
  project.scenes[sId]=scene(); delete project.scenes[current];
  // mover em rotas
  for(const arr of Object.values(project.routes)){ const i=arr.indexOf(current); if(i>=0) arr[i]=sId; }
  // mover conex√µes
  project.connections.forEach(c=>{
    if(c.from===current) c.from=sId;
    if(c.to===current) c.to=sId;
  });
  current=sId; buildRoutesPanel(); syncInspector(); draw(); renameNodeInTimeline(sId);
};
$('dupScene').onclick=()=>{
  const s=scene(); let id=current+'-copy'; let i=1; while(project.scenes[id]) id=current+`-copy${i++}`;
  project.scenes[id]={bg:s.bg?{...s.bg}:null, chars:s.chars.map(c=>({...c})), speaker:s.speaker, text:s.text, options:(s.options||[]).map(o=>({...o}))};
  const r = getRouteOf(current); if(r){ project.routes[r].push(id); }
  current=id; buildRoutesPanel(); syncInspector(); draw(); addNodeToTimeline(id);
};
$('delScene').onclick=()=>{
  if(sortedKeys().length<=1){ alert('Precisa haver ao menos 1 cena.'); return; }
  if(!confirm(`Excluir cena "${current}"?`)) return;
  delete project.scenes[current];
  for(const [r,arr] of Object.entries(project.routes)){ const i=arr.indexOf(current); if(i>=0) arr.splice(i,1); }
  project.connections = project.connections.filter(c=>c.from!==current && c.to!==current);
  current = sortedKeys()[0]; buildRoutesPanel(); syncInspector(); draw(); removeNodeFromTimeline(current);
};
$('addChoiceRow').onclick=()=>{ const s=scene(); (s.options||(s.options=[])).push({text:'',next:''}); renderChoicesTable(); draw(); };
speakerInput.oninput=()=>{ scene().speaker=speakerInput.value; draw(); };
textInput.oninput=()=>{ scene().text=textInput.value; draw(); };

/* ===========================================================
   Imagens (fundo/personagens)
=========================================================== */
function loadImageFile(file){return new Promise((res,rej)=>{const url=URL.createObjectURL(file);const img=new Image();img.onload=()=>res({img,src:url,origin:'file',name:file.name});img.onerror=()=>rej();img.src=url;});}
$('addBgFileBtn').onclick=()=>$('addBgFile').click();
$('addBgFile').addEventListener('change',async ev=>{ const f=ev.target.files[0]; if(!f) return; try{ scene().bg=await loadImageFile(f); draw(); }finally{ ev.target.value=''; } });

$('addCharFileBtn').onclick=()=>$('addCharFile').click();
$('addCharFile').addEventListener('change',async ev=>{ const f=ev.target.files[0]; if(!f) return; try{ const p=await loadImageFile(f); const c={...p,x:120,y:160,w:240,h:340}; scene().chars.push(c); active=c; draw(); }finally{ ev.target.value=''; } });

let active=null, drag=null;
function draw(){
  const s=scene(); ctx.clearRect(0,0,canvas.width,canvas.height);
  if(s.bg) ctx.drawImage(s.bg.img,0,0,canvas.width,canvas.height);
  for(const c of s.chars) ctx.drawImage(c.img,c.x,c.y,c.w,c.h);
  // Caixa de di√°logo (preview simples)
  const hasName = s.speaker && s.speaker.trim();
  const hasText = s.text && s.text.trim();
  const box = $('dialogBox'), nameWrap=$('namePlate'), nm=$('speakerName'), txt=$('dialogText'), chWrap=$('choicesPrev');
  if(hasName||hasText||(s.options&&s.options.length)){
    box.style.display='block';
    nameWrap.style.display = hasName ? 'block' : 'none';
    nm.textContent = s.speaker||'';
    txt.textContent = s.text||'';
    chWrap.innerHTML='';
    (s.options||[]).forEach(o=>{ const b=document.createElement('span'); b.textContent=o.text||'(vazio)'; b.className='btn'; chWrap.appendChild(b); });
  } else { box.style.display='none'; nameWrap.style.display='none'; nm.textContent=''; txt.textContent=''; chWrap.innerHTML=''; }
}
canvas.addEventListener('mousedown',(e)=>{
  const s=scene(), rect=canvas.getBoundingClientRect(), x=e.clientX-rect.left, y=e.clientY-rect.top;
  active=null;
  for(let i=s.chars.length-1;i>=0;i--){
    const c=s.chars[i]; if(x>=c.x&&x<=c.x+c.w&&y>=c.y&&y<=c.y+c.h){ active=c; s.chars.push(s.chars.splice(i,1)[0]); drag={mode:'move',dx:x-c.x,dy:y-c.y}; break; }
  }
  draw();
});
canvas.addEventListener('mousemove',(e)=>{
  if(!drag||!active) return;
  const rect=canvas.getBoundingClientRect(), x=e.clientX-rect.left, y=e.clientY-rect.top;
  if(drag.mode==='move'){ active.x=clamp(x-drag.dx,-active.w,canvas.width); active.y=clamp(y-drag.dy,-active.h,canvas.height); }
  draw();
});
window.addEventListener('mouseup',()=>{ drag=null; });
canvas.addEventListener('wheel',(e)=>{ if(!active||!e.shiftKey) return; e.preventDefault(); const f=(e.deltaY<0)?1.06:0.94, cx=active.x+active.w/2, cy=active.y+active.h/2; active.w=clamp(active.w*f,24,4096); active.h=clamp(active.h*f,24,4096); active.x=cx-active.w/2; active.y=cy-active.h/2; draw(); },{passive:false});
window.addEventListener('keydown',(e)=>{ if(e.key==='Delete'&&active){ const s=scene(); s.chars=s.chars.filter(c=>c!==active); active=null; draw(); } });
/* ===========================================================
   SAVE/LOAD/EXPORT
=========================================================== */
function exportableJSON(){
  const out={routes:project.routes, connections:project.connections, scenes:{}};
  for(const [id,sc] of Object.entries(project.scenes)){
    out.scenes[id]={ bg:sc.bg?{src:sc.bg.src,origin:sc.bg.origin,name:sc.bg.name||null}:null,
      chars:sc.chars.map(c=>({src:c.src,origin:c.origin,name:c.name||null,x:c.x,y:c.y,w:c.w,h:c.h})),
      speaker:sc.speaker||'', text:sc.text||'', options:(sc.options||[]).map(o=>({text:o.text,next:o.next})) };
  } return out;
}
$('saveJSON').onclick=()=>{ const blob=new Blob([JSON.stringify(exportableJSON(),null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='otome_projeto.json'; a.click(); };
$('loadJSONBtn').onclick=()=>$('loadJSON').click();
$('loadJSON').addEventListener('change',async ev=>{
  const f=ev.target.files[0]; if(!f) return;
  try{
    const data=JSON.parse(await f.text()); project={routes:data.routes||{}, scenes:{}, connections:data.connections||[]};
    const ids=Object.keys(data.scenes||{}).sort(naturalCompare);
    for(const id of ids){
      const sd=data.scenes[id];
      const sc={bg:null,chars:[],speaker:sd.speaker||'',text:sd.text||'',options:sd.options||[]};
      if(sd.bg && sd.bg.src){ try{ const img=new Image(); await new Promise((res,rej)=>{img.onload=res;img.onerror=rej; img.crossOrigin='anonymous'; img.src=sd.bg.src;}); sc.bg={img,src:sd.bg.src,origin:'url'}; }catch{} }
      for(const ch of (sd.chars||[])){ try{ const img=new Image(); await new Promise((res,rej)=>{img.onload=res;img.onerror=rej; img.crossOrigin='anonymous'; img.src=ch.src;}); sc.chars.push({img,src:ch.src,origin:'url',x:ch.x,y:ch.y,w:ch.w,h:ch.h}); }catch{} }
      project.scenes[id]=sc;
    }
    current=ids[0]||Object.keys(project.scenes)[0]||'1';
    ensureScene(current);
    buildRoutesPanel(); syncInspector(); draw(); rebuildTimelineFromProject();
  }catch(err){ console.error(err); alert('JSON inv√°lido.'); }
  ev.target.value='';
});

// Exporta jogo: usa connections como fallback de fluxo/choices
$('exportGame').onclick=()=>{
  const data=exportableJSON();
  // embute choices derivados das connections quando op√ß√µes estiverem vazias
  const derived = JSON.parse(JSON.stringify(data));
  for(const [id,sc] of Object.entries(derived.scenes)){
    const outs = (derived.connections||[]).filter(c=>c.from===id).map(c=>c.to);
    if((!sc.options || sc.options.length===0) && outs.length){
      sc.options = outs.map(t=>({text:t, next:t}));
    }
  }
  const html=makeRuntimeHTML(derived);
  const blob=new Blob([html],{type:'text/html'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='otome_jogo.html'; a.click();
};
function makeRuntimeHTML(data) {
  const json = JSON.stringify(data);
  return `<!DOCTYPE html><html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Otome ‚Äî Jogo</title>
<style>
body{margin:0;background:#0f0f10;color:#fff;font-family:system-ui}
#wrap{max-width:1080px;margin:12px auto;position:relative}
#canvas{display:block;margin:auto;background:#000;border-radius:8px}
#box{position:absolute;left:50%;bottom:12px;transform:translateX(-50%);width:86%;
     background:rgba(0,0,0,.72);border:1px solid rgba(255,255,255,.12);
     border-radius:16px;padding:14px 18px 16px}
#name{display:block;width:max-content;margin:0 auto 8px auto;padding:6px 16px;
      border-radius:12px;background:linear-gradient(145deg,#1e2a44,#2b4270);
      border:1px solid #4a6a98;font-weight:700}
#txt{text-align:center;line-height:1.55;font-size:17px;margin:0;padding:0 14px}
#choices{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:10px}
#choices button{background:#2a3345;border:1px solid #3e5375;border-radius:8px;
      padding:6px 12px;color:#cfe1ff;cursor:pointer}
#choices button:hover{background:#3a4d6b}
</style>
</head>
<body>
<div id="wrap">
  <canvas id="canvas" width="960" height="540"></canvas>
  <div id="box">
    <div id="name" style="display:none"><span id="nm"></span></div>
    <p id="txt"></p>
    <div id="choices"></div>
  </div>
</div>
<script>
const data = ${json};
const c = document.getElementById('canvas'), ctx = c.getContext('2d');
const nmWrap = document.getElementById('name'), nm = document.getElementById('nm'),
      txt = document.getElementById('txt'), choices = document.getElementById('choices');
const cache = new Map();
function load(src){
  return new Promise((res,rej)=>{
    if(cache.has(src)) return res(cache.get(src));
    const img = new Image();
    img.crossOrigin='anonymous';
    img.onload = ()=>{ cache.set(src,img); res(img); };
    img.onerror = rej;
    img.src = src;
  });
}
const sorted = ()=>Object.keys(data.scenes).sort();
let cur = sorted()[0];
async function drawScene(id){
  cur = id;
  const sc = data.scenes[id];
  if(!sc) return;
  ctx.clearRect(0,0,c.width,c.height);
  if(sc.bg && sc.bg.src){
    try{ const im = await load(sc.bg.src); ctx.drawImage(im,0,0,c.width,c.height); }catch{}
  }
  for(const ch of (sc.chars||[])){
    try{ const im = await load(ch.src); ctx.drawImage(im,ch.x,ch.y,ch.w,ch.h); }catch{}
  }
  if(sc.speaker && sc.speaker.trim()){
    nmWrap.style.display='block'; nm.textContent=sc.speaker;
  } else {
    nmWrap.style.display='none'; nm.textContent='';
  }
  txt.textContent = sc.text || '';
  choices.innerHTML = '';
  const outs = (data.connections||[]).filter(c=>c.from===id).map(c=>c.to);
  const opts = sc.options && sc.options.length ? sc.options : outs.map(t=>({text:t,next:t}));
  if(opts.length){
    opts.forEach(o=>{
      const b = document.createElement('button');
      b.textContent = o.text || '(vazio)';
      b.onclick = ()=>drawScene(o.next);
      choices.appendChild(b);
    });
  } else {
    const b = document.createElement('button');
    b.textContent = 'Reiniciar';
    b.onclick = ()=>drawScene(sorted()[0]);
    choices.appendChild(b);
  }
}
drawScene(cur);
<\/script>
</body></html>`;
}

/* ===========================================================
   Timeline (fluxo visual com liga√ß√µes manuais)
=========================================================== */
const timelineWrap=$('timelineWrap');
const timelineCanvas=$('timelineCanvas'), g=timelineCanvas.getContext('2d');
const nodesLayer=$('nodesLayer');
let showEdges=true;
let nodes = {}; // id -> {x,y,w,h,el}
function setTimelineSize(){
  const r=timelineWrap.getBoundingClientRect();
  timelineCanvas.width=r.width; timelineCanvas.height=r.height;
}
window.addEventListener('resize',()=>{ setTimelineSize(); drawTimeline(); });

function addNodeToTimeline(id, x, y){
  if(nodes[id]) return;
  const el=document.createElement('div'); el.className='node'; el.dataset.id=id;
  const route = getRouteOf(id) || '';
  el.dataset.route = route || '';
  el.innerHTML = `
    <div class="title">${id}</div>
    <div class="routeTag">${route?('Rota '+route):'Neutra'}</div>
    <div class="connect" title="Arraste para ligar"></div>
  `;
  nodesLayer.appendChild(el);
  const pos = {x: x ?? Math.random()*400+80, y: y ?? Math.random()*220+80, w: el.offsetWidth, h: el.offsetHeight, el};
  nodes[id]=pos;
  enableDrag(el);
  enableConnector(el);
}
function renameNodeInTimeline(newId){
  // rebuild tudo (simplifica)
  rebuildTimelineFromProject();
}
function removeNodeFromTimeline(){ rebuildTimelineFromProject(); }
function selectNodeInTimeline(id){
  // foco visual simples
  Object.values(nodes).forEach(n=>n.el.style.outline='none');
  if(nodes[id]){ nodes[id].el.style.outline='2px solid #4a6a98'; }
}
function rebuildTimelineFromProject(){
  nodesLayer.innerHTML=''; nodes={};
  // Distribui√ß√£o b√°sica por rota (colunas)
  const rotas=Object.keys(project.routes);
  const rotaCols = rotas.length? rotas : [''];
  const wrapRect = timelineWrap.getBoundingClientRect();
  const colW = Math.max(220, (wrapRect.width-60)/(rotaCols.length+1));
  function addList(list, route, col){
    list.forEach((id, i)=>{
      ensureScene(id);
      addNodeToTimeline(id, 40+col*colW, 60 + i*120);
    });
  }
  if(rotas.length){
    rotas.forEach((r,i)=> addList(project.routes[r], r, i));
  }
  // cenas neutras
  const neutrals = sortedKeys().filter(id=>!getRouteOf(id));
  addList(neutrals,'', rotaCols.length);

  drawTimeline();
}
function drawEdge(a,b){
  if(!a||!b) return;
  const startX=a.x+a.w, startY=a.y+a.h/2;
  const endX=b.x, endY=b.y+b.h/2;
  const midX=(startX+endX)/2;
  g.beginPath();
  g.moveTo(startX, startY);
  g.bezierCurveTo(midX, startY, midX, endY, endX, endY);
  g.lineWidth=2.5; g.strokeStyle='rgba(138,180,248,.85)';
  g.stroke();
}
function drawTimeline(){
  const r=timelineWrap.getBoundingClientRect();
  timelineCanvas.width=r.width; timelineCanvas.height=r.height;
  g.clearRect(0,0, timelineCanvas.width, timelineCanvas.height);
  if(!showEdges) return;
  for(const c of project.connections){
    drawEdge(nodes[c.from], nodes[c.to]);
  }
}
function enableDrag(el){
  let start=null;
  el.addEventListener('mousedown',(e)=>{
    if(e.target.classList.contains('connect')) return; // conector tem sua pr√≥pria intera√ß√£o
    const id=el.dataset.id, n=nodes[id];
    start={x:e.clientX, y:e.clientY, ox:n.x, oy:n.y};
    el.style.cursor='grabbing';
  });
  window.addEventListener('mousemove',(e)=>{
    if(!start) return;
    const id=el.dataset.id, n=nodes[id];
    n.x=start.ox+(e.clientX-start.x); n.y=start.oy+(e.clientY-start.y);
    el.style.transform = `translate(${n.x}px, ${n.y}px)`;
    drawTimeline();
  });
  window.addEventListener('mouseup',()=>{ if(start){ el.style.cursor='grab'; start=null; } });
  // primeira posi√ß√£o
  queueMicrotask(() => {
    const n = nodes[el.dataset.id];
    el.style.transform = `translate(${n.x}px, ${n.y}px)`;
  });
}

function enableConnector(el){
  const knob = el.querySelector('.connect');
  let dragging=null;
  knob.addEventListener('mousedown',(e)=>{
    e.stopPropagation(); dragging={from:el.dataset.id};
  });
  window.addEventListener('mousemove',(e)=>{
    if(!dragging) return;
    drawTimeline(); // limpa
    // desenha cabo tempor√°rio
    const a = nodes[dragging.from];
    const startX=a.x+a.w, startY=a.y+a.h/2;
    const endX=e.clientX - timelineWrap.getBoundingClientRect().left;
    const endY=e.clientY - timelineWrap.getBoundingClientRect().top;
    const midX=(startX+endX)/2;
    g.beginPath(); g.moveTo(startX,startY);
    g.bezierCurveTo(midX,startY, midX,endY, endX,endY);
    g.lineWidth=2.5; g.strokeStyle='rgba(150,180,248,.5)'; g.setLineDash([6,4]);
    g.stroke(); g.setLineDash([]);
  });
  window.addEventListener('mouseup',(e)=>{
    if(!dragging) return;
    // detecta alvo
    const mx=e.clientX - timelineWrap.getBoundingClientRect().left;
    const my=e.clientY - timelineWrap.getBoundingClientRect().top;
    let target=null;
    for(const [id,n] of Object.entries(nodes)){
      if(mx>=n.x && mx<=n.x+n.w && my>=n.y && my<=n.y+n.h){ target=id; break; }
    }
    if(target && target!==dragging.from){
      project.connections.push({from:dragging.from, to:target});
      drawTimeline();
    }
    dragging=null;
  });
}

/* Mostrar/ocultar edges + auto layout */
$('btnToggleEdges').onclick=()=>{ showEdges=!showEdges; $('btnToggleEdges').classList.toggle('on', showEdges); drawTimeline(); };
$('btnAutoLayout').onclick=()=>{
  // layout simples por rota + ordem
  rebuildTimelineFromProject();
};

/* ===========================================================
   Editor de personagem (iframe) ‚Äî sincroniza√ß√£o em tempo real
=========================================================== */
const charPanel=$('charEditorPanel'), charFrame=$('charFrame');
$('openCharEditor').onclick=()=>{ charPanel.classList.add('open'); charPanel.setAttribute('aria-hidden','false'); };
$('closeCharEditor').onclick=()=>{ charPanel.classList.remove('open'); charPanel.setAttribute('aria-hidden','true'); };

// injeta um script leve no iframe para postar a PNG sempre que algo mudar
charFrame.addEventListener('load', ()=>{
  try{
    const doc = charFrame.contentDocument || charFrame.contentWindow.document;
    const code = `
      (function(){
        const prev = document.getElementById('preview');
        const controls = document.getElementById('controls') || document.body;
        let send=()=>{ try{ parent.postMessage({type:'CHAR_UPDATE', png: prev.toDataURL('image/png')}, '*'); }catch(e){} };
        controls.addEventListener('click', send, true);
        controls.addEventListener('input', send, true);
        controls.addEventListener('change', send, true);
        window.addEventListener('keyup', send, true);
        setTimeout(send, 300);
      })();
    `;
    const s = doc.createElement('script'); s.textContent = code; doc.body.appendChild(s);
  }catch(e){
    console.warn('N√£o foi poss√≠vel injetar no iframe (origem diferente?)', e);
  }
});

// Recebe PNG e aplica como personagem ‚Äúvivo‚Äù na cena
window.addEventListener('message', (ev)=>{
  const d = ev.data||{};
  if(d.type==='CHAR_UPDATE' && typeof d.png==='string'){
    const img = new Image();
    img.onload = ()=>{
      const s=scene();
      let slot = s.chars.find(c=>c.origin==='editor-live');
      if(!slot){
        slot = {img, src:d.png, origin:'editor-live', x:canvas.width*0.35, y:canvas.height*0.1, w:canvas.width*0.32, h:canvas.height*0.75};
        s.chars.push(slot);
      }else{
        slot.img = img; slot.src = d.png;
      }
      draw();
    };
    img.src = d.png;
  }
});


/* ===========================================================
   Tabs & init
=========================================================== */
document.querySelectorAll('#centerTabs .tab, #viewTabs button').forEach(b=>{
  b.addEventListener('click',()=>{
    const sceneView = b.dataset.view==='scene' || b.id==='tabScene';
    document.querySelectorAll('#centerTabs .tab').forEach(t=>t.classList.toggle('active', t===b || t.dataset.view===b.dataset.view));
    document.getElementById('tabScene')?.classList.toggle('active', sceneView);
    document.getElementById('tabTimeline')?.classList.toggle('active', !sceneView);
    document.getElementById('stageWrap').style.display = sceneView ? 'block' : 'none';
    document.getElementById('timelineWrap').style.display = sceneView ? 'none' : 'block';
    draw(); drawTimeline();
  });
});

function init(){
  fitCanvasToParent();
  ensureScene(current);
  if(!project.routes.A) project.routes.A=[];
  buildRoutesPanel(); syncInspector();
  rebuildTimelineFromProject();
  draw();
}
init();
</script>
</body>
</html>
